---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bitcoin-regtest-deployment
  namespace: bitcoin
  labels:
    app: bitcoin-regtest
  
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: bitcoin-regtest
  
  template:
    metadata:
      labels:
        app: bitcoin-regtest
    
    spec:

      # Define a shared volume
      volumes:
        - name: shared-data
          emptyDir: {}

      # Define init containers
      initContainers:
        - name: init-file-generator
          image: debian:stable-slim
          imagePullPolicy: "IfNotPresent"
          command:
            - /bin/bash
          args: 
            - -ec
            - |
              #!/bin/bash

              SHARED_VOL_DIR="/mnt/shared"


              tee -a $SHARED_VOL_DIR/bitcoin.conf << END
              regtest=1 #chain=regtest

              [regtest]
              # Accept command line and JSON-RPC commands
              server=1
              # Username for JSON-RPC connections
              rpcuser="$BTC_RPCUSER"
              # Password for JSON-RPC connections
              rpcpassword="$BTC_RPCPASSWORD"

              # Allow JSON-RPC connections from, by default only localhost are allowed
              rpcallowip=$BTC_RPCALLOWIP

              bind=$BTC_RPCBIND
              rpcbind=$BTC_RPCBIND
              rpcport=$BTC_RPC_PORT
              dbcache=512
              banscore=1
              rpcthreads=256
              rpcworkqueue=256
              rpctimeout=100

              # Accept public REST requests (default: 0)
              # rest=$BTC_REST_ENABLE

              # output all debug info
              # debug=$BTC_LOG_DEBUG

              # disablewallet=$BTC_DISABLEWALLET
              disablewallet=0

              # printtoconsole=$BTC_PRINTTOCONSOLE
              printtoconsole=1

              addresstype=legacy
              changetype=legacy
              fallbackfee=0.00001

              # Maintain a full transaction index, used by the getrawtransaction rpc call (default: 0)
              # txindex=$BTC_TXINDEX
              txindex=1
              END

          
          env:
            - name: VERSION
              value: "25.0"
            - name: ENV
              value: "DEV"
            - name: BTC_NETWORK
              value: "regtest"
            - name: BTC_PRINTTOCONSOLE
              value: "1"
            - name: BTC_DISABLEWALLET
              value: "0"
            - name: BTC_TXINDEX
              value: "1"
            - name: BTC_RPCBIND
              value: "0.0.0.0"
            - name: BTC_RPCALLOWIP
              value: "0.0.0.0/0"
            - name: BTC_RPCPASSWORD
              value: "devnet"
            - name: BTC_RPCUSER
              value: "devnet"
            - name: BTC_RPC_PORT
              value: "18443"
            - name: BTC_P2P_PORT
              value: "18444"
            - name: BTC_LOG_DEBUG
              value: "0"
            - name: BTC_REST_ENABLE
              value: "0"


          volumeMounts:
            - name: shared-data
              mountPath: /mnt/shared

      containers:
      - name: bitcoin-regtest-container
        image: minikube/bitcoin:v1
        # image: nginx:latest
        imagePullPolicy: Never

        volumeMounts:
        - name: shared-data
          mountPath: /mnt/shared
        
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 100m
        
        ports:
          - containerPort: 18444
            protocol: TCP
          - containerPort: 18443
            protocol: TCP
          - containerPort: 18433
            protocol: TCP
          - containerPort: 18444
            protocol: UDP
          - containerPort: 18443
            protocol: UDP
          - containerPort: 18433
            protocol: UDP

        env:
          - name: VERSION
            value: "25.0"
          - name: ENV
            value: "DEV"
          - name: BTC_NETWORK
            value: "regtest"
          - name: BTC_PRINTTOCONSOLE
            value: "1"
          - name: BTC_DISABLEWALLET
            value: "0"
          - name: BTC_TXINDEX
            value: "1"
          - name: BTC_RPCBIND
            value: "0.0.0.0"
          - name: BTC_RPCALLOWIP
            value: "0.0.0.0/0"
          - name: BTC_RPCPASSWORD
            value: "devnet"
          - name: BTC_RPCUSER
            value: "devnet"
          - name: BTC_RPC_PORT
            value: "18443"
          - name: BTC_P2P_PORT
            value: "18444"
          - name: BTC_LOG_DEBUG
            value: "0"
          - name: BTC_REST_ENABLE
            value: "0"

      - name: bitcoin-miner-sidecar
        image: minikube/bitcoin-miner-sidecar:v1
        imagePullPolicy: Never
        
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 100m

        env:
          - name: INIT_BTC_BLOCKS
            value: "200"
          - name: BTC_BLOCK_GEN_TIME
            value: "10"
          - name: BITCOIN_RPC_HOST
            value: "localhost"
          - name: BITCOIN_RPC_PORT
            value: "18443"
          - name: MINER_ADDRESS
            value: "moU2g2zzH3qLYCNPXGPAMqsgxr2Bw15V2j"
          - name: BTC_RPCPASSWORD
            value: "devnet"
          - name: BTC_RPCUSER
            value: "devnet"